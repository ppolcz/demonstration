\ProvidesPackage{polcz}

\RequirePackage{physics}
\RequirePackage{xparse}
\RequirePackage{amsmath}
\RequirePackage[utf8]{inputenc}

% http://ctan.org/pkg/tcolorbox
\RequirePackage[breakable,skins]{tcolorbox}


% \usepackage[
%     hyperfootnotes = false,
%     colorlinks = true,
%     linkcolor = blue,
%     urlcolor  = blue,
%     citecolor = blue,
%     anchorcolor = blue,
%     pagebackref = false
%     ]{hyperref}

% Options
\DeclareOption{nohref}{\let\hrefopt = 0}
\DeclareOption{ownhref}{\let\hrefopt = 1}
\DeclareOption{href}{\let\hrefopt = 2}
\DeclareOption{nothm}{\let\thm = 0}
\DeclareOption{thmhu}{\let\thm = 1}
\DeclareOption{thmen}{\let\thm = 2}
\DeclareOption{ccsgyak}{\let\ccsgyak = 1}
\ExecuteOptions{nohref}
\ProcessOptions\relax

\ifx\hrefopt 2
    \RequirePackage{hyperref}
    \let\hrefopt = 1
\fi

% Brackets and braces
% REDEFINED, AND AUGMENTED BASED ON Physics 1.3 package
\DeclareDocumentCommand\quantity{}{{\ifnum\z@=`}\fi\@quantity}
\DeclareDocumentCommand\@quantity{ t\big t\Big t\bigg t\Bigg g o d() d|| d<> }
{ % Flexible automatic bracketing of an expression in () or [] or {} or ||
    % Handles manual override of sizing
    \IfBooleanTF{#1}{\let\ltag\bigl \let\rtag\bigr}{
        \IfBooleanTF{#2}{\let\ltag\Bigl \let\rtag\Bigr}{
            \IfBooleanTF{#3}{\let\ltag\biggl \let\rtag\biggr}{
                \IfBooleanTF{#4}
                {\let\ltag\Biggl \let\rtag\Biggr}
                {\let\ltag\left \let\rtag\right}
            }
        }
    }
    % Handles actual bracketing
    \IfNoValueTF{#5}{
        \IfNoValueTF{#6}{
            \IfNoValueTF{#7}{
                \IfNoValueTF{#8}{
                    \IfNoValueTF{#9}
                    {()}
                    {\ltag<{#9}\rtag>}
                }
                {\ltag(#7\rtag) \IfNoValueTF{#9}{}{|#9|}}
            }
            {\ltag(#7\rtag) \IfNoValueTF{#8}{}{|#8|}}
        }
        {\ltag[#6\rtag] \IfNoValueTF{#7}{}{(#7)} \IfNoValueTF{#8}{}{|#8|}}
    }
    {\ltag\lbrace#5\rtag\rbrace  \IfNoValueTF{#6}{}{[#6]} \IfNoValueTF{#7}{}{(#7)} \IfNoValueTF{#8}{}{|#8|}}
    \ifnum\z@=`{\fi}
}
\DeclareDocumentCommand\qty{}{\quantity} % Shorthand for \quantity
\DeclareDocumentCommand\pqty{ l m }{\braces#1{\lparen}{\rparen}{#2}}
\DeclareDocumentCommand\bqty{ l m }{\braces#1{\lbrack}{\rbrack}{#2}}
\DeclareDocumentCommand\Bqty{ l m }{\braces#1{\lbrace}{\rbrace}{#2}}
\DeclareDocumentCommand\vqty{ l m }{\braces#1{\lvert}{\rvert}{#2}}
\DeclareDocumentCommand\dqty{ l m }{\braces#1{<}{>}{#2}}

\DeclareDocumentCommand\dmqty{m}{\left<\begin{matrix}#1\end{matrix}\right>}
\DeclareDocumentCommand\sdmqty{m}{\dqty{\begin{smallmatrix}#1\end{smallmatrix}}}



\ifx\hrefopt 1

    \newcounter{todoAngol}
    \providecommand\langol[2][]{%
        \addtocounter{todoAngol}{1}%
        \global\csdef{taName\thetodoAngol}{#2}%
        \global\csdef{taLabel\thetodoAngol}{#1}%
        \hypertarget{ta:\thetodoAngol}{}\hyperlink{taBack:\thetodoAngol}{#2}%
    }
    \providecommand\refangol[2][]{%
        \global\csdef{taDesc:#1}{#2}%
    }
    \providecommand\angol[2][]{%
        \addtocounter{todoAngol}{1}%
        \global\csdef{taDesc\thetodoAngol}{#1}%
        \global\csdef{taName\thetodoAngol}{#2}%
        \hypertarget{ta:\thetodoAngol}{}\hyperlink{taBack:\thetodoAngol}{#2}%
    }
    \providecommand\angolI[2][]{\angol[#2]{#1}}
    \providecommand{\listoftodosangol}[1]
    {
        \newpage
        \section*{Megjegyzések angol kifejezések és helyesírás kapcsán}

        \ifboolexpr{ test {\ifnumcomp{0}{=}{\thetodoAngol}} }
        { % then
        }
        { % else
            \begin{enumerate}
                \foreach \x in {1,...,\thetodoAngol} {
                    \item \hypertarget{taBack:\x}{}\hyperlink{ta:\x}{\csuse{taName\x}} -- \csuse{taDesc\x}\csuse{taDesc:\csuse{taLabel\x}}
                    % taLabel: $\csuse{taLabel\x}$
                }
            \end{enumerate}

            % \foreach \x in {1,...,\thetodoAngol} {
            %     \csuse{taName\x} \\
            % }
        }
    }
\else

\fi


% \DeclareDocumentCommand{\pcbTitleHelper}{s O{} O{}}
% {
%     \IfBooleanTF{#4}{%
%         #2 \hfill\color{#1} {\footnotesize \tt #3}%
%     }{%
%         #2 \hfill\color{#1} \textit{\footnotesize #3}
%     }
% }

\newtcbox{\TODO}[1][red]{on line,arc=5pt,colback=#1!10!white,colframe=#1!50!black,
    before upper={\rule[-3pt]{0pt}{10pt}},boxrule=1pt, boxsep=0pt,left=4pt,right=4pt,top=2pt,bottom=2pt}

\newtcbox{\TODOx}[1][red]{on line,arc=5pt,colback=#1!10!white,colframe=#1!50!black,
    before upper={\rule[-3pt]{0pt}{10pt}},boxrule=1pt, boxsep=0pt,left=6pt,right=6pt,top=6pt,bottom=6pt}

%\DeclareDocumentEnvironment{\TODOx}{s O{red} m D<>{6pt} D<>{6pt} D<>{2pt} D<>{2pt}}
%{
%    \IfBooleanTF{#1}{%
%        \begin{tcolorbox}[on line,arc=7pt,colback=#2!10!white,colframe=#2!50!black,
%            before upper={\rule[-3pt]{0pt}{10pt}},boxrule=1pt, boxsep=0pt,left=#4,right=#5,top=#6,bottom=#7]#3\end{tcolorbox}
%    }{%
%        \begin{tcolorbox}[on line,arc=7pt,colback=#2!10!white,colframe=#2!50!black,
%            before upper={\rule[-3pt]{0pt}{10pt}},boxrule=1pt, boxsep=0pt,left=8pt,right=8pt,top=8pt,bottom=8pt]#3\end{tcolorbox}
%    }
%}
%{}

\DeclareDocumentCommand{\pcbTitleHelper}{m m m t\matlab}
{
    \IfBooleanTF{#4}{%
        #2 \hfill\color{#1} {\footnotesize \tt #3}%
    }{%
        #2 \hfill\color{#1} \textit{\footnotesize #3}
    }
}

% Colorbox
\colorlet{cImportantBaseColor}{red!50!black}
\colorlet{cImportantTitleColor}{cImportantBaseColor!10}
\colorlet{cImportantBackColor}{cImportantBaseColor!35!yellow!10}
\definecolor{cMatlabBaseColor}{rgb}{0.95,0.95,0.95}
% o: optional tcolorbox arguments
% g: title
% O: title comment
% O: base color
% O: background color
% O: title background color
\DeclareDocumentEnvironment{pcolorbox}
{ o g O{} O{cImportantBaseColor} O{cImportantBackColor} O{cImportantTitleColor} O{cImportantBaseColor} t\matlab}
{%
    \IfBooleanTF{#8}{
        \begin{tcolorbox}[
        oversize,
        enhanced,
        breakable,
        colback=cMatlabBaseColor,
        boxrule=1pt, arc=4pt, left=6pt, right=6pt, top=6pt, bottom=6pt,
        boxsep=0pt,
        toptitle=4pt,
        bottomtitle=4pt,
        fonttitle=\bfseries,
        coltitle=black,
        colbacktitle=cMatlabBaseColor!90!black,
        subtitle style={
            boxrule=0.4pt,
            colback=cMatlabBaseColor!90!black},
        % lifted shadow={1mm}{-2mm}{3mm}{0.1mm}{black!50!white},
        title=\pcbTitleHelper{#7}{\IfNoValueF{#2}{#2}}{#3}\matlab,
        \IfNoValueT{#2}{\IfNoValueT{#3}{notitle}},
        \IfNoValueF{#1}{#1}
        ]%
    }{
        \begin{tcolorbox}[
        oversize,
        enhanced,
        breakable,
        colframe=#4!50, colback=#5,
        boxrule=1pt, arc=4pt, left=6pt, right=6pt, top=6pt, bottom=6pt,
        boxsep=0pt,
        toptitle=4pt,
        bottomtitle=4pt,
        fonttitle=\bfseries,
        coltitle=black,
        colbacktitle=#6,
        subtitle style={
            boxrule=0.4pt,
            colback=#6},
        % lifted shadow={1mm}{-2mm}{3mm}{0.1mm}{black!50!white},
        title=\pcbTitleHelper{#7}{\IfNoValueF{#2}{#2}}{#3},
        \IfNoValueT{#2}{\IfNoValueT{#3}{notitle}},
        \IfNoValueF{#1}{#1}
        ]%
    }%
}{%
    \end{tcolorbox}%
}


\DeclareDocumentCommand{\pcbsub}{ s g O{} O{cImportantBaseColor} t\matlab}
{%
    \tcbsubtitle{%
        \IfBooleanTF{#5}{%
            \pcbTitleHelper{#4}{\IfNoValueF{#2}{#2}}{#3}\matlab%
        }{%
            \pcbTitleHelper{#4}{\IfNoValueF{#2}{#2}}{#3}%
        }%
    }%
}


\DeclareDocumentEnvironment{pcbexample}
{s G{} O{}}
{%
    \IfBooleanTF{#1}
    {\begin{pcolorbox}{#2}[#3][blue][blue!10][blue!20]}%
    {\begin{pcolorbox}[notitle]{}[][blue][blue!10][blue!20]}%
}{
    \end{pcolorbox}
}






\DeclareDocumentCommand{\Hiba}{s t\it t\n O{red} g}
{
    \IfNoValueTF{#5}
    {%
        \color{#4}%
        \IfBooleanT{#1}{\bfseries}%
        \IfBooleanT{#2}{\itshape}%
        \IfBooleanT{#3}{\normalfont}%
    }
    {%
        {\color{#4}%
        \IfBooleanT{#1}{\bfseries}%
        \IfBooleanT{#2}{\itshape} #5}%
        \IfBooleanT{#3}{\normalfont}%
    }
}

\DeclareDocumentCommand{\Atir}{s t\it t\n O{blue} g}%
{%
    \IfNoValueTF{#5}%
    {%
        \color{#4}%
        \IfBooleanT{#1}{\bfseries}%
        \IfBooleanT{#2}{\itshape}%
        \IfBooleanT{#3}{\normalfont}%
    }{%
        {\color{#4}%
        \IfBooleanT{#1}{\bfseries}%
        \IfBooleanT{#2}{\itshape} #5}%
        \IfBooleanT{#3}{\normalfont}%
    }%
}

\DeclareDocumentCommand{\Normal}{s t\it t\n O{black} g}
{
    \IfNoValueTF{#5}
    {%
        \color{#4}%
        \IfBooleanT{#1}{\bfseries}%
        \IfBooleanT{#2}{\itshape}%
        \IfBooleanT{#3}{\normalfont}%
    }
    {%
        {\color{#4}%
        \IfBooleanT{#1}{\bfseries}%
        \IfBooleanT{#2}{\itshape} #5}%
        \IfBooleanT{#3}{\normalfont}%
    }
}





\ifx\thm 1

    \providecommand\lemmaTitle{Lemma}
    \providecommand\remarkTitle{Remark}
    \providecommand\propositionTitle{Állítás}
    \providecommand\applicationTitle{Alkalmazás}
    \providecommand\exampleTitle{Példa}
    \providecommand\theoremTitle{Tétel}
    \providecommand\proofTitle{Bizonyítás}

\else\ifx\thm 2

    \providecommand\lemmaTitle{Lemma}
    \providecommand\remarkTitle{Remark}
    \providecommand\propositionTitle{Proposition}
    \providecommand\applicationTitle{Application}
    \providecommand\exampleTitle{Example}
    \providecommand\theoremTitle{Theorem}
    \providecommand\proofTitle{Proof}

\fi\fi


\ifx\thm\undefined
\else

    \newcounter{pczexample}
    \DeclareDocumentEnvironment{example}
    {s o}
    {%
        \refstepcounter{pczexample}%
        \bigbreak\noindent\textbf{{\exampleTitle} \thepczexample.} \IfNoValueF{#2}{(#2) }%
    }
    {
        \hfill$\triangleleft$
    }

    \DeclareDocumentEnvironment{cExample}
    {s o O{}}
    {%
        \refstepcounter{pczexample}%
        \IfBooleanTF{#1}
        {\begin{pcbexample}*{{\exampleTitle} \thepczexample. \IfNoValueF{#2}{\normalfont(#2)}}[#3]}
        {\begin{pcbexample}\textbf{{\exampleTitle} \thepczexample.} \IfNoValueF{#2}{(#2) }}%
    }
    {
        \end{pcbexample}%
    }

    \newcounter{pcztheorem}
    \DeclareDocumentEnvironment{theorem}
    {s o}
    {%
        \refstepcounter{pcztheorem}%
        \bigbreak\noindent\textbf{{\theoremTitle} \thepcztheorem.} \IfNoValueF{#2}{(#2) }%
    }
    {
        \hfill$\triangleleft$
    }

    \DeclareDocumentEnvironment{cTheorem}
    {s o}
    {%
        \refstepcounter{pcztheorem}%
        \begin{pcolorbox}{{\theoremTitle} \thepcztheorem. \IfNoValueF{#2}{\normalfont (#2)}}%
    }{%
        \end{pcolorbox}%
    }


    \newcounter{pczapplication}
    \DeclareDocumentEnvironment{application}
    {s o}
    {
        \refstepcounter{pczapplication}
        \bigbreak\noindent\textbf{{\applicationTitle} \thepczapplication}\IfNoValueF{#2}{ (#2)}\textbf{. }
    }
    {
        \hfill$\triangleleft$
    }

    \DeclareDocumentEnvironment{remark}
    {s o}
    {
        \refstepcounter{pczapplication}
        \bigbreak\noindent\textit{{\remarkTitle} \thepczapplication}\IfNoValueF{#2}{ (#2)}\textbf{. }
    }
    {
        \hfill$\triangleleft$
    }

    \newcounter{pczlemma}
    \DeclareDocumentEnvironment{lemma}
    {s o}
    {
        \refstepcounter{pczlemma}
        \bigbreak\noindent\textbf{{\lemmaTitle} \thepczlemma}\IfNoValueF{#2}{ (#2)}\textbf{. }
    }
    {
        \hfill$\triangleleft$
    }

    \newcounter{pczproposition}
    \DeclareDocumentEnvironment{proposition}
    {s o}
    {
        \refstepcounter{pczproposition}
        \bigbreak\noindent\textbf{{\propositionTitle} \thepczproposition}\IfNoValueF{#2}{ (#2)}\textbf{. }
    }
    {
        \hfill$\triangleleft$\newline
    }

    \DeclareDocumentEnvironment{cProposition}
    {s o}
    {%
        \refstepcounter{pczproposition}%
        \IfBooleanTF{#1}
        {\begin{pcolorbox}{{\propositionTitle} \thepczproposition. \IfNoValueF{#2}{\normalfont(#2) }}}
        {\begin{pcolorbox}[notitle]\textbf{{\propositionTitle} \thepczproposition. }\IfNoValueF{#2}{(#2) }}
        %
    }{%
        \end{pcolorbox}%
    }

    \DeclareDocumentEnvironment{proof}
    {s o}
    {
        \bigbreak\noindent\textit{{\proofTitle}}\IfNoValueF{#2}{ (#2)}\textit{. }
    }
    {
        \hfill$\square$
    }

\fi

\ifx\ccsgyak\undefined\else
    \newcounter{pczmatlab}
    \DeclareDocumentEnvironment{matlab}
    {s o m}
    {
        \begin{pcolorbox}{\refstepcounter{pczmatlab}Matlab \thepczmatlab. %
        \IfNoValueF{#2}{\normalfont #2}}[\tt #3]\matlab
    }
    {
        \end{pcolorbox}
    }

\fi

% max 9 nr of arguments
\DeclareDocumentEnvironment{pczLearnEnvironment}
{s t\alpha t\asdas O{default} m d|| d<> r() R<>{def}}
{
    \noindent{\tt HEADER\_BEGIN} \\
    \IfBooleanTF{#1}{1: STAR}{1: NO STAR} \\
    \IfBooleanTF{#2}{2: alpha}{2: NO alpha} \\
    \IfBooleanTF{#3}{3: beta}{3: NO beta} \\
    \IfNoValueTF{#4}{No fourth argument}{4: #4} \\
    \IfNoValueTF{#5}{No fifth argument}{5: #5} \\
    \IfNoValueTF{#6}{No sixth argument}{6: #6} \\
    \IfNoValueTF{#7}{No seventh argument}{7: #7} \\
    \IfNoValueTF{#8}{No 8th argument}{8: #8} \\
    \IfNoValueTF{#9}{No 9th argument}{9: #9} \\
    \noindent{\tt HEADER\_END} \\
    \noindent{\tt ENVIRONMENT\_BEGIN} \\
}
{
    \noindent{\tt ENVIRONMENT\_END} \\
}

% \begin{pczLearnEnvironment}*\alpha\asdas[b]{}|c|<d>(required argument)<re>
% \end{pczLearnEnvironment}
%
% \begin{pczLearnEnvironment}\alpha{}(required argument)<re>
% \end{pczLearnEnvironment}


\DeclareDocumentCommand\pmat{ s m O{0} m O{0} m }
{
    {
        \newtoks\matrixtoks
        \global\matrixtoks = {}
        \newcount\rowcount
        \newcount\colcount
        \rowcount = #3
        \loop
        \colcount = #5
        {
            \loop
            \edef\addtoks{%
                \ifnum \colcount = #5 \else & \fi
                #2\IfBooleanTF{#1}{%
                    _{%
                        \ifnum #4 > #5 \the\rowcount \fi %
                        \ifnum #6 > #5 \the\colcount \fi
                    }%
                }{}%
            } % indexek
            \global\matrixtoks = \expandafter{\the\expandafter\matrixtoks\addtoks}
            \advance \colcount by 1
            \ifnum \colcount < #6 \repeat
        }
        \advance \rowcount by 1
        \ifnum \rowcount < #4
            \global\matrixtoks = \expandafter{\the\matrixtoks \\ }
            \repeat
    }
    \the\matrixtoks
}




